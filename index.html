<!DOCTYPE html>
<html>
<head>
	<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
  <script src="js/howler.min.js"></script>

	<link rel="stylesheet" type="text/css" href="css/normalize.css">
	<link rel="stylesheet" type="text/css" href="css/arcsong.css">
	<link href='http://fonts.googleapis.com/css?family=Raleway:300,400,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Josefin+Sans:400,700' rel='stylesheet' type='text/css'>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="clearfix main">
    <div class="nav">
        <img class="back-button" src="img/back.svg" alt="back button" data-behavior='back'>
        <img class="help-button" src="img/help.svg" alt="help button" data-behavior='help'>
    </div>  
    <div id="landing-page">
        <div id="description">Visualize your music.</div>
    	<img src="img/ltta.svg" alt="arc chart for Rush's song, Leave that thing alone">
        <div class='caption'>LEAVE THAT THING ALONE<br>by RUSH</div>
    	<div id="buttons">
    		<div id="nav">
                <div class='action' data-behavior='next'>
                   <div style="display: table;overflow: hidden;height: 47px;margin:0 auto">
                     <div style="display: table-cell; vertical-align: middle;">
                       <div>
                         GET STARTED
                       </div>
                     </div>
                   </div>                
                </div>                
                <div id="gallery-button">
                   <div style="display: table;overflow: hidden;height: 47px;margin:0 auto">
                     <div style="display: table-cell; vertical-align: middle;">
                       <div>
                         GALLERY
                       </div>
                     </div>
                   </div>            
                </div>            
				<div id="about-button">
                   <div style="display: table;overflow: hidden;height: 47px;margin:0 auto">
                     <div style="display: table-cell; vertical-align: middle;">
                       <div>
                         ABOUT
                       </div>
                     </div>
                   </div>                     
                </div>
    		</div>
    	</div>
    </div>
    <div id="transition-finder">
        <div class="main-container">
            <div class="directions">First, separate the song into sections<br>by finding the big transitions.</div> 
            <div class="controls">
                <img class="play button" src="img/play.svg">
                <img class="pause button" src="img/pause.svg">
                <img class="transition button" src="img/found-transition.svg">
                <img class="back-5 button" src="img/back5.svg">
                <img class="back-x button" src="img/back-x.svg">
                <img class="done button" data-behavior="next" src="img/done.svg">
                
            </div>
            <div class="player">
                <div class="player-background">
                    <div class="progress-bar"></div>
                </div> 
                <div class="elapsed-time">
                   <div style="display: table;overflow: hidden;height: 55px;margin:0 auto">
                     <div style="display: table-cell; vertical-align: middle;">
                       <div id='elapsed-time-id'>
                         0:00
                       </div>
                     </div>
                   </div>                     
                </div>
                <div class="remaining-time">
                   <div style="display: table;overflow: hidden;height: 55px;margin:0 auto">
                     <div style="display: table-cell; vertical-align: middle;">
                       <div id='remaining-time-id'>
                         -0.00
                       </div>
                     </div>
                   </div>                 
                </div>
            </div>
        </div>
    </div>
    <div id="group-sections">
        <div class="directions">Now, drag similar-sounding parts into groups.</div>
        <div class="editor">
            <div class="original">
                <div class="song">
                    <div class="background"></div>
                    <div class="sections">
                        <section draggable="true"><div></div></section>
                        <section draggable="true"><div></div></section>
                        <section><div></div></section>
                    </div>
                </div>
            </div>
            <div class="group">
                <div class="song">
                    <div class="controls">
                        <img class="play button" src="img/play_60px.svg">
                        <img class="delete button" src="img/delete.svg">
                    </div>
                    <div class="background"></div>
                    <div class="sections">
                        <section><div></div></section>
                        <section><div style="visibility: hidden"></div></section>
                        <section><div style="visibility: hidden"></div></section>
                    </div>
                </div>
            </div>
            <div class="group">
                <div class="song">
                    <div class="controls">
                        <img class="play button" src="img/play_60px.svg">
                        <img class="delete button" src="img/delete.svg">
                    </div>
                    <div class="background"></div>
                    <div class="sections">
                        <section><div></div></section>
                        <section><div style="visibility: hidden"></div></section>
                        <section><div style="visibility: hidden"></div></section>
                    </div>
                </div>
            </div>
            <div class="group">
                <div class="song">
                    <div class="controls">
                        <img class="play button" src="img/play_60px.svg">
                        <img class="delete button" src="img/delete.svg">
                    </div>
                    <div class="background"></div>
                    <div class="sections">
                        <section><div></div></section>
                        <section><div style="visibility: hidden"></div></section>
                        <section><div style="visibility: hidden"></div></section>
                    </div>
                </div>
            </div>
            <div class="group">
                <div class="song">
                    <div class="controls">
                        <img class="play button" src="img/play_60px.svg">
                        <img class="delete button" src="img/delete.svg">
                    </div>
                    <div class="background"></div>
                    <div class="sections">
                        <section><div></div></section>
                        <section><div style="visibility: hidden"></div$></section>
                        <section><div style="visibility: hidden"></div></section>
                    </div>
                </div>
            </div>            
            <div class="group">
                <div class="song">
                    <div class="controls">
                        <img class="play button" src="img/play_60px.svg">
                        <img class="delete button" src="img/delete.svg">
                    </div>
                    <div class="background"></div>
                    <div class="sections">
                        <section><div></div></section>
                        <section><div style="visibility: hidden"></div></section>
                        <section><div style="visibility: hidden"></div></section>
                    </div>
                </div>
            </div>            
            <div class="group">
                <div class="song">
                    <div class="controls">
                        <img class="play button" src="img/play_60px.svg">
                        <img class="delete button" src="img/delete.svg">
                    </div>
                    <div class="background"></div>
                    <div class="sections">
                        <section><div></div></section>
                        <section><div style="visibility: hidden"></div></section>
                        <section><div style="visibility: hidden"></div></section>
                    </div>
                </div>
            </div>            
        </div>
    </div>
    <script>
        
        //----------------------
        // Main app interactions
        //----------------------
        
        var state = 2;
        init();
        
        // Create custom events corresponding to user actions      
        $('.nav').on('click','[data-behavior~=back]', function() {
            console.log("back-button clicked");
            $(".main").trigger('back.page');
        });
        
        // Act on custom events
        $('.main').on('next.page', function() {
            changeState(1);
        });    
        $('.main').on('back.page', function() {
            changeState(-1);
        });
        
        // Function definitions
        function changeState(x) {
            console.log("stateChange: " + state + " --> " + (state + x)); 
            state += x;
            
            var pages = [
                'landing-page',
                'transition-finder',
                'group-sections'];
            
            for (var i = 0; i < pages.length; i++) {
                if (state != i) {
                    $('#' + pages[i]).addClass('inactive');
//                    $('#' + pages[i]).animate({opacity:0},500};
                } else {
                    $('#' + pages[i]).removeClass('inactive');
//                    $('#' + pages[i]).animate({opacity:100},500};
                }
            }
            
            // remove navigation on homepage
            if (state == 0) {
                $('.nav').addClass('inactive');
            } else {
                $('.nav').removeClass('inactive');
            }
            
        }
        function init() {
            changeState(0);
        };
        
        //--------------
        // Landing page
        //--------------
        
        $('#landing-page').on('click','[data-behavior~=next]', function() {
            $(".main").trigger('next.page');
        });        
        
        //-------------------------
        // Transition finding page
        //-------------------------
        
        var transitions = [];
        var duration = 15; // hardcoded song and duration - hack for now
        var prog = $(".progress-bar");
        var sound = new Howl({
            urls: ['audio/animate2.mp3'], // hack: hardcoded song
            onend: function() {
                $('#transition-finder').removeClass('playing');
                prog.animate({width:"0%"},500);
//                if (state == 3) {
//                    $("#group-sections .progress").animate({width:"0%"},500);
//                    sound.stop();
//                    sound.play();
//                };  
                },
            onpause: function() {
                $('#transition-finder').removeClass('playing');
                prog.stop();
            },
            onplay: function() {
                $('#transition-finder').addClass('playing');
                animateProgress(prog);
//                progressBar3();
                }
            });
                
        // trigger custom events
        $("#transition-finder").on('click','[data-behavior~=next]', function () {
            changeState(1);
        });
        $(".play").click(function() {
            sound.play();
        });
        $(".pause").click(function() {
            sound.pause();
        });  
        $(".back-5").click(function() {   
            if (sound.pos() > 5) {
                sound.pos(sound.pos() - 5);
            } else { 
                sound.pos(0);
            };
            sound.pause();
            sound.play();
        });     
        $(".transition").click(function() {
            transitions.push(sound.pos());            
            $(".player-background").append("<div class='transition-marker'></div>")
            $(".player-background div:last").css({"left": getProgress(sound,duration) + "%"}).animate({"opacity":"1"});
        });
        
        // Define functions
        function animateProgress(e) {
            e.css("width",getProgress(sound,duration) + "%");
            e.animate({
                width:"100%"
            },{
                duration: 1000*(duration - sound.pos()),
                easing: "linear",
                step: updateTimers})};            
        function getProgress(x,dur) {
            return x.pos()*100/dur;
        };
        function addZero(num) {
            return (num >= 0 && num < 10) ? "0" + num : num + "";
        };        
        function updateTimers() { 
            pos = (sound.pos()).toFixed(0);
            minE = Math.floor(pos/60);
            secE = addZero(Math.floor(pos % 60));
            minR = Math.floor(duration / 60) - minE;
            secR = addZero(Math.floor((duration - pos) % 60));
            $('#elapsed-time-id').text(minE + ':' + secE);
            $('#remaining-time-id').text("-" + minR + ':' + secR);
           }; 
        
        //---------------
        // Grouping page
        //---------------
        
        var sound2 = new Howl({
                urls: ['audio/animate2.mp3'], // hack: hardcoded song
                loop: true
            });
        
        sound2.sprite({'clip': [7000,1000]});
        
        var newSections  = []
        
        transitions = [1,2,3,4,5,5.5,6,9];
        var newTransitions = [0.0].concat(transitions.concat([duration]));
        
        $('.original .song .sections').children().remove();
        for (var i = 0; i < newTransitions.length -1; i++) {
            newSections.push([i,newTransitions[i],newTransitions[i+1]]);
        }
        for (var i = 0; i < newSections.length; i++) {
            $('.original .song .sections').append('<section><div></div></section>');
            var start = newSections[i][1],
                end   = newSections[i][2];
            var dur   = end - start;
            $(".original .song .sections section:last").css("width", dur*100 / duration + "%");
            $(".original .song .sections section:last div").attr({
                'data-section': i,
                'data-group': 0
            });
            $(".original .song .sections section:last div").data({
                'data-section': i,
                'data-group': 0
            });            
            var currentSprites = sound2.sprite();
            currentSprites[i] = [start * 1000, 1000 * dur];
            sound2.sprite(currentSprites);
        }
    
        $("#group-sections groups section div").addClass('inactive');
        $("#group-sections .group").hover(
            function(){
                $(this).find(".controls").css('opacity',0);
                $(this).find(".controls").css("visibility","visible");
                $(this).find(".controls").animate({"opacity":1},500);
            }, function(){ $(this).find(".controls").css("visibility","hidden")});
                        
        $("#group-sections section div").hover(
          function(){
            $(this).append('<div class="progress"></div>');
              var index = $(this).attr("data-section")
              sound2.play(index);
              
        }, function(){
            sound2.stop();
            $(this).find(".progress").remove();
        });
        function progressBar3() {
            $("#group-sections .progress").animate({
                width:"100%"
            },{
                duration: 1000*(duration - sound2.pos()),
                easing: "linear"})};      
        $(".editor section div").attr({
            draggable: "true"
//            ondragstart: "sectionDrag(this.data)"
        });
        
//        var mySection = $(".editor section div");
//        mySection.ondragstart = function(e) {
////            e.dataTransfer.setData('Text','bob');
//            console.log(e.dataTransfer);
//            console.log("bob");
////            return false;
//        }

        
        console.log($(".editor section div").length);
        $(".editor section div").on('dragstart', function(e) {
//            $(this).animate({opacity:0},100);
//            $(this).addClass('draggedFrom');
            var group = $(this).attr('data-group');
            var section = $(this).attr('data-section');
            console.log(e);
            event.dataTransfer().setData('Text','bob');
            console.log(event.dataTransfer.getData());
        });
        
        // need to add events in js, rather than html.
        function sectionDrag(ev) {
            console.log(ev);
//            var evGroup = ev.target.attr('data-group');
            console.log(ev.target.data);
//            var evSection = ev.target.attr('data-section');
            console.log($(document).find('[data-group=' + evGroup + '],[data-section=' + evSection + ']'));
        };
//        function sectionDrag() {
//            $(this).addClass('inactive');
//            //            console.log($(this));
//        };
        
    </script>    
</body>
</html>