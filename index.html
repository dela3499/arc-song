<!DOCTYPE html>
<html>
<head>
	<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
  <script src="js/howler.min.js"></script>

	<link rel="stylesheet" type="text/css" href="css/normalize.css">
	<link rel="stylesheet" type="text/css" href="css/arcsong.css">
	<link href='http://fonts.googleapis.com/css?family=Raleway:300,400,700' rel='stylesheet' type='text/css'>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="clearfix main">
    <div class="nav">
        <img class="back-button" src="img/back.svg" alt="back button" data-behavior='back'>
        <img class="help-button" src="img/help.svg" alt="help button" data-behavior='help'>
    </div>  
    <div id="landing-page">
    	<div id="logo"><a href="#">ARC<span>SONG</span></a></div>
    	<div id="example"><img src="img/ltta.svg" alt="arc chart for Rush's song, Leave that thing alone"></div>
    	<div id="description">Create arc diagrams for your favorite songs.</div>
    	<div id="pitch">It's free. There's no sign-in. <a href="http://www.youtube.com/">Watch a clip.</a></div>
    	<div id="buttons">
    		<div id="upload-song-button" class="button" data-behavior='next'>
               <div style="display: table;overflow: hidden;height: 90px;margin:0 auto">
                 <div style="display: table-cell; vertical-align: middle;">
                   <div>
                     UPLOAD<br>SONG
                   </div>
                 </div>
               </div>                
            </div>
    		<div id="nav">
				<div id="about-button">
                   <div style="display: table;overflow: hidden;height: 50px;margin:0 auto">
                     <div style="display: table-cell; vertical-align: middle;">
                       <div>
                         ABOUT
                       </div>
                     </div>
                   </div>                     
                </div>
    			<div id="blog-button">
                   <div style="display: table;overflow: hidden;height: 50px;margin:0 auto">
                     <div style="display: table-cell; vertical-align: middle;">
                       <div>
                         BLOG
                       </div>
                     </div>
                   </div>            
                </div>
    		</div>
    	</div>
    </div>
    <div id="transition-finder">
        <div class="main-container">
            <div class="directions">First, separate the song into sections<br>by finding the big transitions.</div> 
            <div class="controls">
                <img class="play" src="img/play.svg">
                <img class="pause" src="img/pause.svg">
                <img class="transition" src="img/found-transition.svg">
                <img class="back-5" src="img/back5.svg">
                <img class="back-x" src="img/back-x.svg">
                <img class="done" data-behavior="next" src="img/done.svg">
                
            </div>
            <div class="player">
                <div class="player-background">
                    <div class="progress-bar"></div>
                </div> 
                <div class="elapsed-time">
                   <div style="display: table;overflow: hidden;height: 55px;margin:0 auto">
                     <div style="display: table-cell; vertical-align: middle;">
                       <div id='elapsed-time-id'>
                         0:00
                       </div>
                     </div>
                   </div>                     
                </div>
                <div class="remaining-time">
                   <div style="display: table;overflow: hidden;height: 55px;margin:0 auto">
                     <div style="display: table-cell; vertical-align: middle;">
                       <div id='remaining-time-id'>
                         -0.00
                       </div>
                     </div>
                   </div>                 
                </div>
            </div>
        </div>
    </div>
    <div id="group-sections">
        <div class="directions">Now, drag similar-sounding parts into groups.</div>
        <div class="editor">
            <div class="original">
                <div class="song">
                    <div class="background"></div>
                    <div class="sections">
                        <section draggable="true"><div></div></section>
                        <section draggable="true"><div></div></section>
                        <section><div></div></section>
                    </div>
                </div>
            </div>
            <div class="group">
                <div class="song">
                    <div class="controls">
                        <img class="play" src="img/play_60px.svg">
                        <img class="delete" src="img/delete.svg">
                    </div>
                    <div class="background"></div>
                    <div class="sections">
                        <section><div></div></section>
                        <section><div style="visibility: hidden"></div></section>
                        <section><div style="visibility: hidden"></div></section>
                    </div>
                </div>
            </div>
            <div class="group">
                <div class="song">
                    <div class="controls">
                        <img class="play" src="img/play_60px.svg">
                        <img class="delete" src="img/delete.svg">
                    </div>                    
                    <div class="background"></div>
                    <div class="sections">
                        <section><div style="visibility: hidden"></div></section>
                        <section><div></div></section>
                        <section><div style="visibility: hidden"></div></section>
                    </div>
                </div>
            </div>
            <div class="group">
                <div class="song">
                    <div class="controls">
                        <img class="play" src="img/play_60px.svg">
                        <img class="delete" src="img/delete.svg">
                    </div>
                    <div class="background"></div>
                    <div class="sections">
                        <section><div style="visibility: hidden"></div></section>
                        <section><div style="visibility: hidden"></div></section>
                        <section><div></div></section>
                    </div>
                </div>
            </div>            
            <div class="group">
                <div class="song">
                    <div class="controls">
                        <img class="play" src="img/play_60px.svg">
                        <img class="delete" src="img/delete.svg">
                    </div>
                    <div class="background"></div>
                    <div class="sections">
                        <section><div></div></section>
                        <section><div style="visibility: hidden"></div></section>
                        <section><div style="visibility: hidden"></div></section>
                    </div>
                </div>
            </div>
            <div class="group">
                <div class="song">
                    <div class="controls">
                        <img class="play" src="img/play_60px.svg">
                        <img class="delete" src="img/delete.svg">
                    </div>
                    <div class="background"></div>
                    <div class="sections">
                        <section><div style="visibility: hidden"></div></section>
                        <section><div></div></section>
                        <section><div style="visibility: hidden"></div></section>
                    </div>
                </div>
            </div>
            <div class="group">
                <div class="song">
                    <div class="controls">
                        <img class="play" src="img/play_60px.svg">
                        <img class="delete" src="img/delete.svg">
                    </div>
                    <div class="background"></div>
                    <div class="sections">
                        <section><div style="visibility: hidden"></div></section>
                        <section><div style="visibility: hidden"></div></section>
                        <section><div></div></section>
                    </div>
                </div>
            </div>    
            <div class="group">
                <div class="song">
                        <img class="next" src="img/next.svg">
                </div>
            </div>                
        </div>
    </div>
    <script>
        
        //----------------------
        // Main app interactions
        //----------------------
        
        var state = 0;
        init();
        
        // Create custom events corresponding to user actions      
        $('.nav').on('click','[data-behavior~=back]', function() {
            console.log("back-button clicked");
            $(".main").trigger('back.page');
        });
        
        // Act on custom events
        $('.main').on('next.page', function() {
            changeState(1);
        });    
        $('.main').on('back.page', function() {
            changeState(-1);
        });
        
        // Function definitions
        function changeState(x) {
            console.log("stateChange: " + state + " --> " + (state + x)); 
            state += x;
            
            var pages = [
                'landing-page',
                'transition-finder',
                'group-sections'];
            
            for (var i = 0; i < pages.length; i++) {
                if (state != i) {
                    $('#' + pages[i]).addClass('inactive');
                } else {
                    $('#' + pages[i]).removeClass('inactive');
                }
            }
            
            // remove navigation on homepage
            if (state == 0) {
                $('.nav').addClass('inactive');
            } else {
                $('.nav').removeClass('inactive');
            }
            
        }
        function init() {
            changeState(0);
        };
        
        //--------------
        // Landing page
        //--------------
        
        $('#landing-page').on('click','[data-behavior~=next]', function() {
            $(".main").trigger('next.page');
        });        
        
        //-------------------------
        // Transition finding page
        //-------------------------
        
        var transitions = [];
        var duration = 15; // hardcoded song and duration - hack for now
        var prog = $(".progress-bar");
        var sound = new Howl({
            urls: ['audio/animate2.mp3'], // hack: hardcoded song
            onend: function() {
                $('#transition-finder').removeClass('playing');
                prog.animate({width:"0%"},500);
//                if (state == 3) {
//                    $("#group-sections .progress").animate({width:"0%"},500);
//                    sound.stop();
//                    sound.play();
//                };  
                },
            onpause: function() {
                $('#transition-finder').removeClass('playing');
                prog.stop();
            },
            onplay: function() {
                $('#transition-finder').addClass('playing');
                animateProgress(prog);
//                progressBar3();
                }
            });
                
        // trigger custom events
        $("#transition-finder").on('click','[data-behavior~=next]', function () {
            changeState(1);
        });
        $(".play").click(function() {
            sound.play();
        });
        $(".pause").click(function() {
            sound.pause();
        });  
        $(".back-5").click(function() {   
            if (sound.pos() > 5) {
                sound.pos(sound.pos() - 5);
            } else { 
                sound.pos(0);
            };
            sound.pause();
            sound.play();
        });     
        $(".transition").click(function() {
            transitions.push(sound.pos());            
            $(".player-background").append("<div class='transition-marker'></div>")
            $(".player-background div:last").css({"left": getProgress(sound,duration) + "%"}).animate({"opacity":"1"});
        });
        
        // Define functions
        function animateProgress(e) {
            e.css("width",getProgress(sound,duration) + "%");
            e.animate({
                width:"100%"
            },{
                duration: 1000*(duration - sound.pos()),
                easing: "linear",
                step: updateMyContent})};            
        function getProgress(x,dur) {
            return x.pos()*100/dur;
        };
        function addZero(num) {
            return (num >= 0 && num < 10) ? "0" + num : num + "";
        };        
        function updateTimers() { 
            pos = (sound.pos()).toFixed(0);
            minE = Math.floor(pos/60);
            secE = addZero(Math.floor(pos % 60));
            minR = Math.floor(duration / 60) - minE;
            secR = addZero(Math.floor((duration - pos) % 60));
            $('#elapsed-time-id').text(minE + ':' + secE);
            $('#remaining-time-id').text("-" + minR + ':' + secR);
           }; 
        
        //---------------
        // Grouping page
        //---------------
        
        $("#group-sections .group").hover(
            function(){
                $(this).find(".controls").css('opacity',0);
                $(this).find(".controls").css("visibility","visible");
                $(this).find(".controls").animate({"opacity":1},500);
            }, function(){ $(this).find(".controls").css("visibility","hidden")});
                        
        $("#group-sections section div").hover(
          function(){
            $(this).append('<div class="progress"></div>');
            sound.play();
        }, function(){
            sound.stop();
            $(this).find(".progress").remove();
        });
        function progressBar3() {
            $("#group-sections .progress").animate({
                width:"100%"
            },{
                duration: 1000*(duration - sound.pos()),
                easing: "linear"})};      
        $(".editor section").attr({
            draggable: "true",
            ondragstart: "sectionDrag(event)"
        });
        function sectionDrag(ev) {

        };
    </script>    
</body>
</html>